function f(h){throw h;}MSIOClient=function(h,i){this.e=[];this.f=new io.Socket(h,{port:i,transports:["websocket","htmlfile","xhr-multipart","xhr-polling"]});this.g=undefined};MSIOClient.prototype.connect=function(h){var i=this;this.f.connect();this.f.on("connect",function(){i.g=new Talker(i.f,i.e);i.g.r();h()})};MSIOClient.prototype.B=function(h,i,a){this.g.sendQuery(h,i,a)};MSIOClient.prototype.k=function(h,i){this.e[h]=i};MSIOClient.prototype.n=function(h){delete this.e[h]};window.MSIOClient=MSIOClient;
MSIOClient.prototype.connect=MSIOClient.prototype.connect;MSIOClient.prototype.query=MSIOClient.prototype.B;MSIOClient.prototype.addQueryObject=MSIOClient.prototype.k;MSIOClient.prototype.delQueryObject=MSIOClient.prototype.n;(function(h){var i=1;h.C=Talker=function(a,b){this.d=a;this.c=1;this.F=false;this.a=[];this.b=b;this.G=i++;this.j={w:2E3};if(undefined!==b)this.b=b};Talker.prototype.r=function(){var a=this;this.d.on("message",function(b){a.t(b)})};Talker.prototype.t=function(a){var b=this,c,e;try{c=JSON.parse(a)}catch(d){sys.log("Invalid json received "+a+" error: "+d);return}if("replyData"===c.type)this.z(c);else if("replyError"==c.type)this.A(c);else if("event"===c.type)this.s(c);else{a=this.c;this.c+=2;this.u(a,
c,function(g,j,k){e=g?b.o(j+1,g.message):b.q(j+1,k);g=JSON.stringify(e);b.d.send(g)})}};Talker.prototype.z=function(a){var b=this.a[a.index];if(undefined===b)f(Error("Unknown reply"));else{clearTimeout(b.timeout);b=b.callback;delete this.a[a.index];b(a.result)}};Talker.prototype.A=function(a){var b=this.a[a.index];if(undefined===b)f(Error("Unknown reply error (wtf)"));else{clearTimeout(b.timeout);b=b.callback;delete this.a[a.index];b(Error(a.error))}};Talker.prototype.sendQuery=function(a,b,c){var e=
this;a={query:a,index:this.c++,args:b};b=JSON.stringify(a);var d=a.index+1;this.c++;this.a[d]={sent:b,expectingIndex:d,callback:c,timeout:setTimeout(function(){e.v(d)},this.j.w)};this.d.send(b)};Talker.prototype.v=function(a){delete this.a[a];f(Error("Query timed out"))};Talker.prototype.u=function(a,b,c){var e=b.query;a!=b.index&&f(Error("Synchronization error"));a=e.split(".");a.length<2&&f(Error("Invalid query specified"));this.m(a,b.args,b.index,c)};Talker.prototype.s=function(a){var b;b=a.event.split(".");
b.length<2&&f(Error("Invalid query specified"));this.l(b,a.args)};Talker.prototype.l=function(a,b){var c=this.i(a,a.length-1),e=a[a.length-1],d,g;if(undefined===c)f(Error("Invalid query object "+c));else if(undefined===c.expose)f(Error("Target object does not expose any functions"));else{d=c.expose[e];if(undefined===d)f(Error("Invalid query path "+e));else{d=d.eventHandler;if(undefined===d)f(Error("Target is not an event handler "+e));else{g=c[d];undefined===g?f(Error("Event api not implemented "+
e)):c[d].call(c,this,b)}}}};Talker.prototype.m=function(a,b,c,e){var d=this.i(a,a.length-1);a=a[a.length-1];var g,j;if(undefined===d)f(Error("Invalid query object "+d));else if(undefined===d.expose)f(Error("Target object does not expose any functions"));else{g=d.expose[a];if(undefined===g)f(Error("Invalid query path "+a));else{g=g["function"];if(undefined===g)f(Error("Target is not a function "+a));else{j=d[g];undefined===j?f(Error("Path api not implemented "+a)):d[g].call(d,this,b,function(k,l){k?
e(k,c,l):e(null,c,l)})}}}};Talker.prototype.i=function(a,b){var c=this.p(a[0]),e;if(undefined===c)console.log("Chain should start with valid object");else{for(var d=1;d<b;d++){e=a[d];if(undefined===c.h){console.log("queryObject does not expose any children");return}else if(undefined===c.h[e]){console.log("queryObject does not expose any children");return}else{c=c.h[e].object;if(undefined===c){console.log("Object does not expose "+e);return}}}return c}};Talker.prototype.p=function(a){var b=undefined;
try{if(undefined==this.b[a]){var c=require(a),e=a;e=e[0].toUpperCase()+e.substring(1,e.length);b=new c[e](this.D);this.b[a]=b}return this.b[a]}catch(d){console.log("Failed to create client object of type "+a)}};Talker.prototype.o=function(a,b){return{type:"replyError",index:a,error:b}};Talker.prototype.q=function(a,b){return{type:"replyData",index:a,result:b}}})(typeof exports==="undefined"?this.talker={}:exports);
